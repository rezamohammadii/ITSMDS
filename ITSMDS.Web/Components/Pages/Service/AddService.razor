@page "/service/create"
@using ITSMDS.Domain.DTOs
@using ITSMDS.Web.ApiClient
@using ITSMDS.Web.Services
@using ITSMDS.Domain.Enums
@inject NavigationManager NavigationManager
@inject ServiceApiClient ServiceApi
@inject ServerApiClient ServerApi
@inject ISweetAlertService SweetAlert

<EditForm Model="@SERVICE" OnValidSubmit="HandleValidSubmit" Class="space-y-6">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <!-- عنوان و برگشت -->
    <div class="d-flex align-items-center justify-content-between gap-4 flex-wrap mb-5">
        <div class="d-flex flex-column">
            <h1 class="h4 fw-bold text-dark text-gradient">
                <Icon Name="IconName.Server" Class="me-2 text-primary" /> افزودن سرویس جدید
            </h1>
            <p class="text-muted mt-1">ایجاد یک سرویس جدید در سیستم</p>
        </div>

        <Button Color="ButtonColor.Warning" Class="me-auto" @onclick="NavigateToServices">
            <Icon Name="IconName.ArrowRight" /> بازگشت
        </Button>
    </div>

    <!-- اطلاعات سرویس -->
    <div class="row g-4">
        <div class="col-md-6">
            <label class="form-label">نام سرویس *</label>
            <InputText class="form-control" @bind-Value="SERVICE.ServiceName" placeholder="مثال: سرویس پرداخت" />
            <ValidationMessage For="@(() => SERVICE.ServiceName)" />
        </div>
        <div class="col-md-6">
            <label class="form-label">مسیر اجرا</label>
            <InputText class="form-control" @bind-Value="SERVICE.ExcutionPath" placeholder="/opt/service/run.sh" />
        </div>
      
    </div>

 
    <div class="row g-4 mt-1">
        <div class="col-md-6">
            <label class="form-label">مسیر فایل مستندات</label>
            <InputText class="form-control" @bind-Value="SERVICE.DocumentFilePath" placeholder="/docs/service.docx" />
        </div>
        <div class="col-md-6">
            <label class="form-label">نسخه</label>
            <InputText class="form-control" @bind-Value="SERVICE.Version" placeholder="مثال: v1.0.0" />
        </div>
    </div>

    <div class="row g-4 mt-1">
        <div class="col-md-3">
            <label class="form-label">امتیاز بحرانی بودن</label>
            <InputSelect class="form-select" @bind-Value="SERVICE.CriticalityScore">
                @foreach (var item in Enum.GetValues(typeof(ServiceEnum.CriticalityScore)))
                {
                    <option value="@item">@item</option>
                }
            </InputSelect>
        </div>

        <div class="col-md-3">
            <label class="form-label">انتخاب سرور</label>
            <InputSelect class="form-select" @bind-Value="SERVICE.ServerName" DisplayName="نام سرور خود را انتخاب کنید">
                @foreach (var server in ALL_SERVER)
                {
                    <option value="@server.ServerName">@server.ServerName</option>
                }
            </InputSelect>
        </div>
        <div class="col-md-3">
            <label class="form-label">پورت</label>
            <InputNumber class="form-control" @bind-Value="SERVICE.Port" placeholder="مثال: 8080" />
        </div>
        <div class="col-md-3">
            <label class="form-label">زمان ایجاد</label>
            <InputDate class="form-control" @bind-Value="CreateTime" placeholder="2025-09-30" />
        </div>
    </div>

    <div class="row g-4 mt-1">
      

        <div class="col-md-6 d-flex align-items-center mt-4">
            <InputCheckbox class="form-check-input me-2" @bind-Value="SERVICE.IsActive" />
            <label class="form-check-label">فعال است</label>
        </div>
    </div>

    <div class="row g-4 mt-1">
        <div class="col-md-12">
            <label class="form-label">توضیحات</label>
            <TextAreaInput @bind-Value="@SERVICE.Description" Rows="3" Class="form-control" />
        </div>
    </div>

    <!-- دکمه‌ها -->
    <div class="d-flex gap-3 pt-4 border-top">
        <Button Color="ButtonColor.Success" Type="ButtonType.Submit" Disabled="@isSubmitting">
            <Icon Name="IconName.Save" Class="me-1" /> ذخیره سرویس
        </Button>

        <Button Color="ButtonColor.Secondary" Type="ButtonType.Button" @onclick="HandleReset" Disabled="@isSubmitting">
            <Icon Name="IconName.ArrowCounterclockwise" Class="me-1" /> بازنشانی
        </Button>
    </div>
</EditForm>

@code {
    private ServiceViewModel SERVICE = new();
    private List<ServerViewModel> ALL_SERVER = new();
    private bool isSubmitting = false;
    private DateOnly CreateTime = DateOnly.FromDateTime(DateTime.Now);



    protected async override Task OnInitializedAsync()
    {
        var serverData = await ServerApi.GetServerListAsync();
        ALL_SERVER = serverData.Data;
    }
    private async void HandleValidSubmit()
    {
        try
        {
            
            isSubmitting = true;
            SERVICE.CreateTime = CreateTime.ToString();
            var res = await ServiceApi.CreateServiceAsync(SERVICE);

            if (!res.Success)
            {
                await SweetAlert.ShowErrorAsync(res.Message);
                return;
            }

            await SweetAlert.ShowSuccessAsync(res.Message);
            NavigationManager.NavigateTo("/services");
        }
        catch (Exception ex)
        {
            await SweetAlert.ShowErrorAsync($"خطا: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void HandleReset() => SERVICE = new();
    private void NavigateToServices() => NavigationManager.NavigateTo("/services");
}

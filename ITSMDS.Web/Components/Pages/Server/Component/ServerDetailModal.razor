<div class="d-flex align-items-center">
    <Icon Name="IconName.Server" Class="text-primary me-3" Size="IconSize.x4"></Icon>
    <div>
        <h5 class="mb-0">اطلاعات سرور</h5>
        <small class="text-muted">جزئیات کامل مشخصات سرور</small>
    </div>
</div>

@if (Server != null)
{
    <div class="server-details">
        <!-- اطلاعات اصلی سرور -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="detail-item">
                    <div class="detail-icon bg-primary-subtle">
                        <Icon Name="IconName.Server" Class="text-primary"></Icon>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">نام سرور</div>
                        <div class="detail-value">@Server.ServerName</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="detail-item">
                    <div class="detail-icon bg-success-subtle">
                        <Icon Name="IconName.Memory" Class="text-success"></Icon>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">حافظه RAM</div>
                        <div class="detail-value">@Server.RAM GB</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- مشخصات سخت‌افزاری -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="detail-item">
                    <div class="detail-icon bg-info-subtle">
                        <Icon Name="IconName.Cpu" Class="text-info"></Icon>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">پردازنده (CPU)</div>
                        <div class="detail-value">@Server.CPU</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="detail-item">
                    <div class="detail-icon bg-warning-subtle">
                        <Icon Name="IconName.Motherboard" Class="text-warning"></Icon>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">مدل مادربرد</div>
                        <div class="detail-value">@Server.MainBoardModel</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- اطلاعات ذخیره‌سازی -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="detail-item">
                    <div class="detail-icon bg-secondary-subtle">
                        <Icon Name="IconName.Hdd" Class="text-secondary"></Icon>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">ظرفیت ذخیره‌سازی</div>
                        <div class="detail-value">@Server.StorageSize GB</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="detail-item">
                    <div class="detail-icon bg-dark-subtle">
                        <Icon Name="IconName.HddStack" Class="text-dark"></Icon>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">نوع ذخیره‌سازی</div>
                        <div class="detail-value">
                            @switch (Server.StorageType)
                            {
                                case 0:
                                    <span class="badge bg-secondary">HDD</span>
                                    break;
                                case 1:
                                    <span class="badge bg-info">SSD</span>
                                    break;
                                case 2:
                                    <span class="badge bg-primary">NVMe</span>
                                    break;
                                default:
                                    <span class="text-muted">نامشخص</span>
                                    break;
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- اطلاعات شبکه و سیستم عامل -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="detail-item">
                    <div class="detail-icon bg-primary-subtle">
                        <Icon Name="IconName.Windows" Class="text-primary"></Icon>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">سیستم عامل</div>
                        <div class="detail-value">@Server.OS</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="detail-item">
                    <div class="detail-icon bg-success-subtle">
                        <Icon Name="IconName.Globe" Class="text-success"></Icon>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">آدرس IP</div>
                        <div class="detail-value">@Server.IpAddress</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- اطلاعات موقعیت و مدیریت -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="detail-item">
                    <div class="detail-icon bg-info-subtle">
                        <Icon Name="IconName.GeoAlt" Class="text-info"></Icon>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">موقعیت فیزیکی</div>
                        <div class="detail-value">@Server.Location</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="detail-item">
                    <div class="detail-icon bg-warning-subtle">
                        <Icon Name="IconName.Person" Class="text-warning"></Icon>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">مدیر سرور</div>
                        <div class="detail-value">@(string.IsNullOrEmpty(Server.ServerManager) ? "ثبت نشده" : Server.ServerManager)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- وضعیت سرور و تاریخ ایجاد -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="detail-item">
                    <div class="detail-icon @GetStatusColor(Server.Status)">
                        <Icon Name="@GetStatusIcon(Server.Status)" Class="@GetStatusTextColor(Server.Status)"></Icon>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">وضعیت سرور</div>
                        <div class="detail-value">
                            @switch (Server.Status)
                            {
                                case 0:
                                    <span class="badge bg-danger">غیرفعال</span>
                                    break;
                                case 1:
                                    <span class="badge bg-success">فعال</span>
                                    break;
                                case 2:
                                    <span class="badge bg-warning">در حال تعمیر</span>
                                    break;
                                case 3:
                                    <span class="badge bg-secondary">آفلاین</span>
                                    break;
                                default:
                                    <span class="badge bg-dark">نامشخص</span>
                                    break;
                            }
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="detail-item">
                    <div class="detail-icon bg-dark-subtle">
                        <Icon Name="IconName.Calendar" Class="text-dark"></Icon>
                    </div>
                    <div class="detail-content">
                        <div class="detail-label">تاریخ ایجاد</div>
                        <div class="detail-value">@(string.IsNullOrEmpty(Server.CreateDate) ? "ثبت نشده" : Server.CreateDate)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- دکمه‌های اقدام -->
        @if (ShowActions)
        {
            <div class="row mt-4">
                <div class="col-12">
                    <div class="d-flex gap-2">
                        @if (PermissionService.HasPermission(PermissionName.SERVER_EDIT))
                        {
                            <button class="btn btn-primary" @onclick="HandleEdit">
                                <Icon Name="IconName.Pencil" Class="me-2"></Icon>
                                ویرایش سرور
                            </button>
                        }
                        @if (PermissionService.HasPermission(PermissionName.SERVER_DELETE))
                        {
                            <button class="btn btn-outline-danger" @onclick="HandleDelete">
                                <Icon Name="IconName.Trash" Class="me-2"></Icon>
                                حذف سرور
                            </button>
                        }
                        <button class="btn btn-outline-secondary" @onclick="HandleBack">
                            <Icon Name="IconName.ArrowLeft" Class="me-2"></Icon>
                            بازگشت
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="text-center py-4">
        <Icon Name="IconName.ExclamationTriangle" Size="IconSize.x4" Class="text-warning mb-3"></Icon>
        <p class="text-muted">هیچ اطلاعاتی برای نمایش وجود ندارد.</p>
        <pre class="small text-muted">Debug: Server == null</pre>
    </div>
}

@code {
    [Parameter] public ServerViewModel Server { get; set; }
    [Parameter] public bool ShowActions { get; set; } = true;
    [Parameter] public EventCallback OnEdit { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }
    [Parameter] public EventCallback OnBack { get; set; }

    [Inject] private PermissionService PermissionService { get; set; }
    [Inject] private ISweetAlertService SweetAlert { get; set; }
    [Inject] private NavigationManager NavigationManager { get; set; }
    [Inject] IJSRuntime JSRuntime { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await PermissionService.InitializeAsync();
    }

    private async Task HandleEdit()
    {
        if (OnEdit.HasDelegate)
        {
            await OnEdit.InvokeAsync();
        }
        else
        {
            NavigationManager.NavigateTo($"/server/edit/{Server.Id}");
        }
    }

    private async Task HandleDelete()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("showDeleteConfirmation", new object[] { "آیا از حذف سرور مطمئن هستید؟" });

        if (confirmed)
        {
            if (OnDelete.HasDelegate)
            {
                await OnDelete.InvokeAsync();
            }
        }
    }

    private async Task HandleBack()
    {
        if (OnBack.HasDelegate)
        {
            await OnBack.InvokeAsync();
        }
        else
        {
            NavigationManager.NavigateTo("/servers");
        }
    }

    private string GetStatusColor(int status)
    {
        return status switch
        {
            1 => "bg-success-subtle",
            2 => "bg-warning-subtle",
            3 => "bg-secondary-subtle",
            _ => "bg-danger-subtle"
        };
    }

    private string GetStatusTextColor(int status)
    {
        return status switch
        {
            1 => "text-success",
            2 => "text-warning",
            3 => "text-secondary",
            _ => "text-danger"
        };
    }

    private IconName GetStatusIcon(int status)
    {
        return status switch
        {
            1 => IconName.CheckCircle,
            2 => IconName.Tools,
            3 => IconName.Power,
            _ => IconName.XCircle
        };
    }
}